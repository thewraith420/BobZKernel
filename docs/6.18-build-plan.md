# 6.18 LTS Build Plan - Ultimate BobZKernel

**Target:** Linux 6.18 LTS with full optimizations
**Hardware:** Lenovo LOQ 15IRH8 (i5-13450HX, RTX 3050, 8GB RAM)
**Support:** LTS until December 2027

---

## Phase 1: Preparation

### Download & Extract
```bash
cd /home/bob/buildstuff/BobzKernel
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.18.tar.xz
tar -xf linux-6.18.tar.xz
mv builds/linux builds/linux-6.14-final
mv linux-6.18 builds/linux
cd builds/linux
```

### Download CachyOS 6.18 Patches
```bash
cd ../../patches
mkdir -p cachyos-6.18
cd cachyos-6.18

# Download all relevant patches
wget https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.18/sched/0001-bore-cachy.patch
wget https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.18/0004-bbr3.patch
wget https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.18/0005-block.patch
wget https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.18/0006-cachy.patch
wget https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.18/0007-crypto.patch
wget https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.18/0008-fixes.patch
wget https://raw.githubusercontent.com/CachyOS/kernel-patches/master/6.18/0009-intel-pstate.patch
```

---

## Phase 2: Apply Patches

### Apply CachyOS Patches (in order)
```bash
cd ../../builds/linux

# Apply patches in order
patch -p1 < ../../patches/cachyos-6.18/0004-bbr3.patch
patch -p1 < ../../patches/cachyos-6.18/0005-block.patch
patch -p1 < ../../patches/cachyos-6.18/0006-cachy.patch
patch -p1 < ../../patches/cachyos-6.18/0007-crypto.patch
patch -p1 < ../../patches/cachyos-6.18/0008-fixes.patch
patch -p1 < ../../patches/cachyos-6.18/0009-intel-pstate.patch

# Apply BORE scheduler last (most likely to have conflicts)
patch -p1 < ../../patches/cachyos-6.18/0001-bore-cachy.patch
```

### Add march=native to Makefile
```bash
# Edit line 578 in Makefile
# Change:
KBUILD_CFLAGS :=
# To:
KBUILD_CFLAGS := -march=native -mtune=native
```

Or use sed:
```bash
sed -i 's/^KBUILD_CFLAGS :=$/KBUILD_CFLAGS := -march=native -mtune=native/' Makefile
```

---

## Phase 3: Configure Kernel

### Start with Current Config
```bash
cp ../../configs/.config .config
make LLVM=1 olddefconfig
```

### Optimize Config for Your Hardware

**Remove unnecessary GPU drivers:**
```bash
./scripts/config --disable CONFIG_DRM_AMDGPU
./scripts/config --disable CONFIG_DRM_RADEON
./scripts/config --disable CONFIG_DRM_NOUVEAU  # Only if using NVIDIA proprietary
```

**Enable ntsync built-in:**
```bash
./scripts/config --enable CONFIG_NTSYNC
```

**Enable LTO Full (Maximum Performance):**
```bash
./scripts/config --disable CONFIG_LTO_NONE
./scripts/config --enable CONFIG_LTO_CLANG_FULL
# With 18GB swap, LTO Full should work without OOM
# Expect 60-90 min build time, 5-10% performance gain
```

**Enable new CachyOS features:**
```bash
./scripts/config --enable CONFIG_CACHY
# BORE scheduler should be auto-enabled by patch
```

**Optimize for VMware/Virtualization (NEW):**
```bash
# Make VHOST drivers built-in for better VM performance
./scripts/config --enable CONFIG_VHOST
./scripts/config --enable CONFIG_VHOST_NET
./scripts/config --enable CONFIG_VHOST_SCSI
./scripts/config --enable CONFIG_VHOST_VSOCK

# Enable IOMMU for better VM I/O performance
./scripts/config --enable CONFIG_INTEL_IOMMU
./scripts/config --enable CONFIG_INTEL_IOMMU_DEFAULT_ON

# Keep KVM optimizations for potential future use
./scripts/config --enable CONFIG_KVM_INTEL
./scripts/config --enable CONFIG_KVM_GUEST

# Better I/O scheduler for VMs
./scripts/config --enable CONFIG_BFQ_GROUP_IOSCHED
./scripts/config --enable CONFIG_MQ_IOSCHED_DEADLINE
```

**Alternative - Use LTO Thin (if Full OOMs or for faster builds):**
```bash
./scripts/config --disable CONFIG_LTO_CLANG_FULL
./scripts/config --enable CONFIG_LTO_CLANG_THIN
# Faster build (35-50 min), 3-7% performance gain
```

### Apply and verify config
```bash
make LLVM=1 KCONFIG_CONFIG=../../configs/.config olddefconfig
```

### Save optimized config
```bash
cp .config ../../configs/.config-6.18
```

---

## Phase 4: Additional Config Optimizations

### Review and disable unused drivers

**Use menuconfig to review:**
```bash
# From another terminal with proper TERM set:
make LLVM=1 menuconfig
```

**Categories to review:**
1. **Device Drivers → Graphics support**
   - Keep: Intel i915, NVIDIA (via DKMS)
   - Remove: AMD, Matrox, AST, etc.

2. **Device Drivers → Network device support**
   - Keep: Intel, Realtek (your laptop's adapters)
   - Remove: Obsolete/rare adapters

3. **Device Drivers → Sound card support**
   - Keep: HD-Audio (Intel/Realtek)
   - Remove: Creative, Asus Xonar, etc.

4. **Filesystems**
   - Keep what you use: ext4, btrfs, vfat, ntfs3
   - Remove: reiserfs, hfs+, etc. if unused

### Or use manual config commands:
```bash
# Disable specific unused drivers (examples)
./scripts/config --disable CONFIG_DRM_RADEON
./scripts/config --disable CONFIG_DRM_AMDGPU
./scripts/config --disable CONFIG_SND_CMIPCI
./scripts/config --disable CONFIG_SND_ENS1370
# Add more as needed
```

---

## Phase 5: Build

### Clean build
```bash
make LLVM=1 clean
```

### Build kernel
```bash
make LLVM=1 KCONFIG_CONFIG=../../configs/.config LOCALVERSION=-BobZKernel -j11 2>&1 | tee ~/bobzkernel-6.18-build.log
```

**Expected build time:**
- LTO Full: 60-90 minutes (recommended with 18GB swap)
- LTO Thin: 35-50 minutes (if Full has issues)

---

## Phase 6: Install & Test

### Install kernel
```bash
cd ../..
sudo ./scripts/install-kernel.sh
```

### Update GRUB
```bash
sudo update-grub
```

### Reboot and test
```bash
sudo reboot
```

### Verify after boot
```bash
uname -r  # Should show 6.18.0-BobZKernel
cat /proc/sys/net/ipv4/tcp_congestion_control  # Should show bbr
lsmod | grep ntsync  # Should NOT be needed (built-in now)
ls -l /dev/ntsync  # Should exist
dkms status  # Check all modules rebuilt
```

---

## Phase 7: Documentation & Commit

### Document changes
```bash
# Create docs/phase3-6.18-lts.md documenting:
# - All CachyOS patches applied
# - BORE scheduler implementation
# - Config optimizations (removed drivers)
# - Performance comparisons
```

### Commit to git
```bash
git add configs/.config-6.18
git add docs/phase3-6.18-lts.md
git add docs/6.18-build-plan.md
git commit -m "Upgrade to Linux 6.18 LTS with BORE scheduler and full CachyOS optimizations"
git push
```

---

## VM Optimization Benefits

**Why these virtualization optimizations matter:**

1. **VHOST built-in** (instead of modules):
   - Eliminates module loading overhead
   - Better I/O performance for VMware VMs
   - Faster VM network and disk operations
   - Especially helps macOS VMs which are I/O intensive

2. **Intel IOMMU**:
   - Hardware-assisted I/O virtualization
   - Better VM memory management
   - Improved security isolation between VMs and host
   - Required for PCI passthrough if you ever need it

3. **Better I/O schedulers**:
   - BFQ (Budget Fair Queueing): Great for desktop + VM workloads
   - mq-deadline: Low-latency I/O for NVMe drives
   - Helps prevent VM I/O from starving host applications

**Note:** These are kernel-level optimizations. For VMware specifically:
- ntsync/fsync are Wine-only (don't help VMware)
- VMware uses its own paravirtualization layer
- Main gains come from better host I/O scheduling and VHOST performance

---

## Expected Performance Gains

**6.18 LTS BobZKernel vs Stock 6.18:**
- march=native: 2-5%
- LTO Full: 5-10% (or 3-7% with Thin)
- BORE scheduler: 5-15% responsiveness improvement
- BBRv3: 10-30% network performance
- CachyOS optimizations: 2-5%
- VHOST built-in: 3-8% VM I/O performance
- Intel IOMMU: Better VM stability and security
- BFQ scheduler: Smoother VM + host multitasking
- **Combined: 20-35% overall improvement with LTO Full**
- **VMware VMs: 10-20% better disk/network I/O**

**Build time improvements:**
- Removed AMD GPU drivers: -5 to -10 minutes
- Optimized config: Smaller kernel, faster builds

---

## Troubleshooting

### If BORE patch fails:
- Check CachyOS repo for updated 6.18 BORE patch
- Try vanilla BORE patch instead of bore-cachy variant
- Apply other patches, skip BORE for now

### If LTO OOMs again:
- Switch to LTO Thin (instead of Full)
- Verify swap is enabled: `swapon --show`
- Reduce parallel jobs: use -j8 instead of -j11

### If build fails:
- Check build log for specific errors
- Verify all LLVM tools installed
- Try without some CachyOS patches to isolate issue

---

## Notes

- **This is an LTS kernel** - supported until December 2027
- No need to upgrade frequently after this
- Keep 6.14 kernel as fallback in GRUB
- Can remove old 6.14 build directory after successful test

---

**Created:** December 29, 2025
**Status:** Ready to execute after 6.14 build completes
**Next:** Test 6.14, then begin 6.18 upgrade
